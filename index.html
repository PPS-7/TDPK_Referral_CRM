<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TDPK International Referral Program</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js?v=1"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; background-color: #f3f4f6; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .status-badge { display:inline-block; padding:0.25rem 0.75rem; border-radius:9999px; font-size:0.75rem; font-weight:500; }
    .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); overflow:auto; }
    .modal-content { background:#1f2937; margin:5% auto; padding:1.5rem; border-radius:0.75rem; width:90%; max-width:800px; }
    .close-button { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
    .close-button:hover { color:white; }
    textarea { resize: vertical; }
  </style>
</head>
<body class="bg-black text-gray-200 p-6 sm:p-10">

<div class="max-w-7xl mx-auto space-y-8">
  <!-- Header -->
  <header class="flex flex-col sm:flex-row items-center justify-between p-6 card bg-gray-800">
    <h1 class="text-3xl font-bold text-white">TDPK International Referral Program</h1>
    <span id="userIdDisplay" class="text-sm text-gray-400">Connected to Google Sheets</span>
  </header>

  <!-- Analytics Dashboard -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="p-6 card bg-gray-800 text-center"><p>Total Leads</p><p id="totalLeadsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Individual Referrals</p><p id="individualReferralsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Agency Referrals</p><p id="agencyReferralsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Approved Candidates</p><p id="approvedCandidatesCount" class="text-3xl">0</p></div>
  </div>

  <!-- CRM Table -->
  <div class="p-6 card bg-gray-800">
    <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-4 sm:space-y-0">
      <h2 class="text-2xl">Referral Leads</h2>
      <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
        <input type="text" id="searchInput" placeholder="Search by name or email..." class="p-2 border rounded-md w-full sm:w-64 bg-gray-700 text-white placeholder-gray-400 border-gray-600">
        <select id="referrerTypeFilter" class="p-2 border rounded-md bg-gray-700 text-white border-gray-600">
          <option value="all">Referrer Type: All</option>
          <option value="Individual">Individual</option>
          <option value="Agency">Agency</option>
        </select>
        <select id="visaStatusFilter" class="p-2 border rounded-md bg-gray-700 text-white border-gray-600">
          <option value="all">Visa Status: All</option>
          <option value="In Progress">In Progress</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
        <button id="addNewLeadBtn" class="bg-blue-600 px-4 py-2 rounded">Add New Lead</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-900">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Referrer Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Referral Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Client Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Visa Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Visa Status</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody" class="bg-gray-800 divide-y divide-gray-700"></tbody>
      </table>
    </div>
    <div id="noResults" class="hidden text-center text-gray-400 mt-4 py-4">No matching leads found.</div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="leadModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('leadModal')">&times;</span>
    <h3 id="modalTitle" class="text-xl mb-4">Add Lead</h3>
    <form id="leadForm" class="space-y-4">
      <input type="hidden" id="leadId" />
      <input id="referrerName" placeholder="Referrer Name" class="w-full p-2 bg-gray-700 text-white"/>
      <input id="referrerEmail" placeholder="Referrer Email" class="w-full p-2 bg-gray-700 text-white"/>
      <input id="referrerPhone" placeholder="Referrer Phone" class="w-full p-2 bg-gray-700 text-white"/>
      <select id="referrerType" class="w-full p-2 bg-gray-700 text-white">
        <option>Individual</option>
        <option>Agency</option>
      </select>
      <input id="clientName" placeholder="Client Name" class="w-full p-2 bg-gray-700 text-white"/>
      <input id="clientEmail" placeholder="Client Email" class="w-full p-2 bg-gray-700 text-white"/>
      <input id="clientPhone" placeholder="Client Phone" class="w-full p-2 bg-gray-700 text-white"/>
      <input id="clientCompany" placeholder="Client Company/Position" class="w-full p-2 bg-gray-700 text-white"/>
      <select id="visaType" class="w-full p-2 bg-gray-700 text-white"><option>DTV</option><option>LTR</option><option>Smart S</option><option>TPC</option></select>
      <select id="visaStatus" class="w-full p-2 bg-gray-700 text-white"><option>In Progress</option><option>Approved</option><option>Rejected</option></select>
      <textarea id="rejectionReason" placeholder="Reason for Rejection" class="w-full p-2 bg-gray-700 text-white hidden"></textarea>
      <div id="individualRewardDiv"><select id="individualReward" class="w-full p-2 bg-gray-700 text-white"><option>Coworking</option><option>Meeting Room</option></select></div>
      <div id="agencyPaymentDiv" class="hidden"><select id="paymentStatus" class="w-full p-2 bg-gray-700 text-white"><option>Pending</option><option>In Progress</option><option>Paid</option></select></div>
      <button class="w-full bg-blue-600 p-2 rounded" type="submit">Save</button>
    </form>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
    <h3 class="text-xl mb-4">Lead Profile</h3>
    <div id="profileContent"></div>
  </div>
</div>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=228435386&single=true&output=csv";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzb4k9Jtp1uTTm9mcyiTxG6p_ZwMsvOlw8owyjvXmGSgn20m-fbyQbjT1lQt9UVFkc/exec";

let leads = [];

async function loadLeads(){
  const res = await fetch(SHEET_CSV_URL + "&v=" + new Date().getTime()); // cache-bust
  const text = await res.text();
  const rows = Papa.parse(text).data;
  leads = rows.slice(1).map((r,i)=>({
    id:i+2, time:r[0], referrer:r[1], email:r[2], phone:r[3], type:r[4], client:r[5], clientEmail:r[6], clientPhone:r[7], company:r[8], visa:r[9], status:r[10], rejection:r[11], reward:r[12], payment:r[13], notes:r[14]?JSON.parse(r[14]):[]
  }));
  renderLeads();
}

function renderLeads(){
  const body = document.getElementById("leadsTableBody");
  body.innerHTML = "";
  const search = document.getElementById("searchInput").value.toLowerCase();
  const typeFilter = document.getElementById("referrerTypeFilter").value;
  const visaFilter = document.getElementById("visaStatusFilter").value;
  const filtered = leads.filter(l=>{
    return (!search || (l.referrer && l.referrer.toLowerCase().includes(search)) || (l.client && l.client.toLowerCase().includes(search)))
      && (typeFilter==="all" || l.type===typeFilter)
      && (visaFilter==="all" || l.status===visaFilter);
  });
  if(filtered.length===0){document.getElementById("noResults").classList.remove("hidden");}
  else {document.getElementById("noResults").classList.add("hidden");}
  filtered.forEach(l=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${l.time}</td><td>${l.referrer}</td><td>${l.type}</td><td>${l.client}</td><td>${l.visa}</td><td>${l.status}</td>
    <td class="text-right"><button onclick="viewLead(${l.id})">View</button><button onclick="editLead(${l.id})">Edit</button><button onclick="deleteLead(${l.id})">Del</button></td>`;
    body.appendChild(tr);
  });
  document.getElementById("totalLeadsCount").innerText=leads.length;
  document.getElementById("individualReferralsCount").innerText=leads.filter(l=>l.type=="Individual").length;
  document.getElementById("agencyReferralsCount").innerText=leads.filter(l=>l.type=="Agency").length;
  document.getElementById("approvedCandidatesCount").innerText=leads.filter(l=>l.status=="Approved").length;
}

document.getElementById("addNewLeadBtn").onclick=()=>openModal("leadModal");
document.getElementById("referrerType").addEventListener("change",e=>{
  document.getElementById("individualRewardDiv").classList.toggle("hidden",e.target.value!=="Individual");
  document.getElementById("agencyPaymentDiv").classList.toggle("hidden",e.target.value!=="Agency");
});
document.getElementById("visaStatus").addEventListener("change",e=>{
  document.getElementById("rejectionReason").classList.toggle("hidden",e.target.value!=="Rejected");
});

document.getElementById("leadForm").onsubmit=async e=>{
  e.preventDefault();
  const data={time:new Date().toISOString(),referrerName:referrerName.value,referrerEmail:referrerEmail.value,referrerPhone:referrerPhone.value,referrerType:referrerType.value,clientName:clientName.value,clientEmail:clientEmail.value,clientPhone:clientPhone.value,clientCompany:clientCompany.value,visaType:visaType.value,visaStatus:visaStatus.value,rejectionReason:rejectionReason.value,individualReward:individualReward.value,paymentStatus:paymentStatus.value};
  await fetch(SCRIPT_URL+"?action=add",{method:"POST",body:JSON.stringify(data)});
  closeModal("leadModal"); loadLeads();
};

function openModal(id){document.getElementById(id).style.display="block";}
function closeModal(id){document.getElementById(id).style.display="none";}

window.onload=loadLeads;

// Cache bust self
(function(){
  const version=new Date().getTime();
  if(!window.location.href.includes("v=")){
    const url=new URL(window.location.href);
    url.searchParams.set("v",version);
    window.location.replace(url.toString());
  }
})();
</script>
</body>
</html>
