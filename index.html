<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TDPK International Referral Program</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; background-color: #0b0f17; }
    .card { background-color: #111826; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .modal { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.45); overflow: auto; }
    .modal-content { background: #111826; margin: 5% auto; padding: 1.25rem; border-radius: 0.75rem; width: 92%; max-width: 860px; }
    .close-button { color: #94a3b8; float: right; font-size: 28px; font-weight: 700; cursor: pointer; }
    .close-button:hover { color: #fff; }
    .input, select, textarea { background: #1f2937; color: #e5e7eb; border: 1px solid #374151; border-radius: .5rem; padding: .55rem .75rem; }
    th, td { padding: .75rem; }
    th { font-size: .75rem; text-transform: uppercase; color: #9ca3af; letter-spacing: .05em; }
    td { color: #e5e7eb; font-size: .95rem; }
    .btn { border-radius: .5rem; padding: .5rem .75rem; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-ghost { background: #0f172a; border: 1px solid #334155; color: #e2e8f0; }
    .btn-ghost:hover { background: #111827; }
    .badge { display: inline-block; border-radius: 9999px; padding: .125rem .5rem; font-size: .75rem; }
    .badge.green { background: #064e3b; color: #a7f3d0; border: 1px solid #065f46; }
    .badge.yellow { background: #78350f; color: #fde68a; border: 1px solid #92400e; }
    .badge.red { background: #7f1d1d; color: #fecaca; border: 1px solid #991b1b; }
    .table-wrap { overflow: auto; border: 1px solid #1f2937; border-radius: .75rem; }
  </style>
</head>
<body class="text-gray-200 p-6 sm:p-10">

  <div class="max-w-7xl mx-auto space-y-8">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 p-6 card">
      <div class="flex items-center space-x-4">
        <h1 class="text-xl sm:text-3xl font-bold text-white">TDPK International Referral Program</h1>
      </div>
      <div class="text-sm text-gray-400">
        <span class="font-semibold">Status:</span> <span id="userIdDisplay">Connected to Google Sheets</span>
      </div>
    </header>

    <!-- Analytics -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Total Leads</p>
        <p id="totalLeadsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Individual Referrals</p>
        <p id="individualReferralsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Agency Referrals</p>
        <p id="agencyReferralsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Approved Candidates</p>
        <p id="approvedCandidatesCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
    </section>

    <!-- CRM Table & Controls -->
    <section class="p-6 card">
      <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-4 sm:space-y-0">
        <h2 class="text-2xl font-semibold text-white">Referral Leads</h2>
        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
          <input type="text" id="searchInput" placeholder="Search by name, email, phone..." class="input w-full sm:w-64" />
          <select id="referrerTypeFilter" class="input w-full sm:w-auto">
            <option value="all">Referrer Type: All</option>
            <option value="Individual">Individual</option>
            <option value="Agency">Agency</option>
          </select>
          <select id="visaStatusFilter" class="input w-full sm:w-auto">
            <option value="all">Visa Status: All</option>
            <option value="In Progress">In Progress</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
          <div class="flex gap-2 w-full sm:w-auto">
            <button id="refreshAll" class="btn btn-ghost w-full sm:w-auto">Refresh</button>
            <button id="addNewLeadBtn" class="btn btn-primary w-full sm:w-auto">Add New Lead</button>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table class="min-w-full">
          <thead class="bg-gray-900 sticky top-0">
            <tr>
              <th>Time</th>
              <th>Referrer Name</th>
              <th>Referral Type</th>
              <th>Client Name</th>
              <th>Visa Type</th>
              <th>Visa Status</th>
              <th class="text-right pr-4">Actions</th>
            </tr>
          </thead>
          <tbody id="leadsTableBody" class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
      <div id="noResults" class="hidden text-center text-gray-400 mt-4 py-4">No matching leads found.</div>
    </section>

    <!-- Master Referral Tracking (View Only) -->
    <section class="p-6 card">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold text-white">Master Referral Tracking (View Only)</h2>
        <a id="openMasterSheetLink" href="#" target="_blank" class="text-sm underline text-blue-400">Open in Google Sheets</a>
      </div>
      <p class="text-gray-400 text-sm mt-1">Mirrors the “Master Referral Tracking” tab. Not editable here.</p>

      <div class="table-wrap mt-6">
        <table class="min-w-full">
          <thead id="masterHead" class="bg-gray-900"></thead>
          <tbody id="masterBody" class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
      <div id="masterEmpty" class="hidden text-center text-gray-400 mt-4 py-4">No data available.</div>
    </section>
  </div>

  <!-- Add/Edit Lead Modal -->
  <div id="leadModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center pb-2">
        <h3 id="modalTitle" class="text-2xl font-semibold text-white">Add New Lead</h3>
        <span class="close-button" onclick="closeModal('leadModal')">&times;</span>
      </div>
      <form id="leadForm" class="space-y-6">
        <input type="hidden" id="rowNumber" />

        <!-- Referrer Details -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-300">Referrer Name</label>
            <input id="ReferrerName" class="input w-full" required />
          </div>
          <div>
            <label class="block text-sm text-gray-300">Referrer Email</label>
            <input id="ReferrerEmail" type="email" class="input w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-300">Referrer Phone</label>
            <input id="ReferrerPhone" class="input w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-300">Referrer Type</label>
            <select id="ReferrerType" class="input w-full">
              <option>Individual</option>
              <option>Agency</option>
            </select>
          </div>
        </div>

        <!-- Client Details -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-300">Client Fullname</label>
            <input id="ClientName" class="input w-full" required />
          </div>
          <div>
            <label class="block text-sm text-gray-300">Client Email</label>
            <input id="ClientEmail" type="email" class="input w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-300">Client Phone Number</label>
            <input id="ClientPhone" class="input w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-300">Client Company/Position</label>
            <input id="ClientCompany" class="input w-full" />
          </div>
        </div>

        <!-- Visa & Status -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-300">Visa Type</label>
            <select id="VisaType" class="input w-full">
              <option>DTV</option>
              <option>LTR</option>
              <option>Smart S</option>
              <option>TPC</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-300">Visa Status</label>
            <select id="VisaStatus" class="input w-full">
              <option>In Progress</option>
              <option>Approved</option>
              <option>Rejected</option>
            </select>
          </div>
        </div>
        <div id="RejectionReasonDiv" class="hidden">
          <label class="block text-sm text-gray-300">Reason for Rejection</label>
          <textarea id="RejectionReason" rows="3" class="input w-full"></textarea>
        </div>

        <!-- Conditional Reward / Payment -->
        <div id="IndividualRewardDiv">
          <label class="block text-sm text-gray-300">Referral Reward Selection</label>
          <select id="IndividualReward" class="input w-full">
            <option value="Coworking">1-month coworking space access</option>
            <option value="Meeting Room">3,000 THB of meeting room credit</option>
          </select>
        </div>
        <div id="AgencyPaymentDiv" class="hidden">
          <label class="block text-sm text-gray-300">Payment Status</label>
          <select id="PaymentStatus" class="input w-full">
            <option>Pending</option>
            <option>Paid</option>
            <option>In Progress</option>
          </select>
        </div>

        <div class="flex items-center justify-end gap-2">
          <button type="button" class="btn btn-ghost" onclick="closeModal('leadModal')">Cancel</button>
          <button id="saveBtn" class="btn btn-primary" type="submit">Save</button>
        </div>
        <p id="formError" class="text-sm text-red-300"></p>
      </form>
    </div>
  </div>

  <!-- Profile (View) Modal with Notes input -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center pb-2">
        <h3 class="text-2xl font-semibold text-white">Lead Profile</h3>
        <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
      </div>
      <div id="profileContent" class="space-y-6"></div>
      <div class="flex justify-end pt-2">
        <button class="btn btn-ghost" onclick="closeModal('profileModal')">Close</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG — SET THESE
     ***********************/
    // View-only Master tab
    const MASTER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=1540779843&single=true&output=csv";

    // Published CSV for the CRM tab (optional fallback read); replace with your CRM Leads tab CSV if you have it published
    const CRM_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=228435386&single=true&output=csv";

    // Apps Script web app (must support actions: load, add, update, delete)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhn8pIbr7hKefG5Xfn1aEsoCRAn4CJK617HR_LFvz1EmgofIKzEwBZt4_s540F8pya/exec";

    // Exact headers for the CRM Leads tab
    const FIELD_ORDER = [
      "Timestamp",
      "Referrer Name",
      "Referrer Email",
      "Referrer Phone",
      "Referrer Type",
      "Individual Reward",
      "Payment Status",
      "Client Name",
      "Client Email",
      "Client Phone",
      "Client Company/Position",
      "Visa Type",
      "Visa Status",
      "Rejection Reason",
      "Notes"
    ];

    /***********************
     * STATE
     ***********************/
    let leads = []; // each: { rowNumber, ...fields }
    let lastLoadedAt = null;

    /***********************
     * UTILS
     ***********************/
    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));
    const cacheBust = (url) => `${url}${url.includes("?") ? "&" : "?"}v=${Date.now()}`;
    const fmtTime = (t) => t ? new Date(t).toLocaleString() : "";
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    function badgeForStatus(status){
      if(status === "Approved") return '<span class="badge green">Approved</span>';
      if(status === "Rejected") return '<span class="badge red">Rejected</span>';
      return '<span class="badge yellow">In Progress</span>';
    }

    function openModal(id){ document.getElementById(id).style.display = "block"; }
    function closeModal(id){ document.getElementById(id).style.display = "none"; }

    function pluckRowToObj(row, headerMap){
      const o = {};
      FIELD_ORDER.forEach((name)=>{
        const i = headerMap[name];
        o[name] = (i != null && row[i] != null) ? row[i] : "";
      });
      return o;
    }

    /***********************
     * LOADERS
     ***********************/
    async function loadLeadsFromScript(){
      const res = await fetch(`${SCRIPT_URL}?action=load`);
      if(!res.ok) throw new Error(`load failed ${res.status}`);
      const payload = await res.json(); // expect array of { rowNumber, fields keyed by headers }
      leads = payload.map(r => ({ rowNumber: r.rowNumber, ...r }));
      lastLoadedAt = Date.now();
      renderLeads();
      renderCounters();
    }

    async function loadLeadsFromCSV(){
      if(!CRM_CSV_URL || CRM_CSV_URL.includes("PASTE_")) { leads = []; renderLeads(); renderCounters(); return; }
      const res = await fetch(cacheBust(CRM_CSV_URL));
      if(!res.ok) throw new Error(`CSV load failed: ${res.status}`);
      const text = await res.text();
      const parsed = Papa.parse(text.trim());
      const rows = parsed.data;
      if(!rows.length) { leads = []; renderLeads(); renderCounters(); return; }
      const headers = rows[0];
      const headerMap = {}; headers.forEach((h,i)=> headerMap[String(h).trim()] = i);
      leads = rows.slice(1).filter(r=>r.length && r.some(c=>String(c).trim()!==""))
        .map((r, idx)=> ({ rowNumber: idx+2, ...pluckRowToObj(r, headerMap) }));
      lastLoadedAt = Date.now();
      renderLeads();
      renderCounters();
    }

    async function loadMaster(){
      try{
        const res = await fetch(cacheBust(MASTER_CSV_URL));
        if(!res.ok) throw new Error(`Master CSV load failed: ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text.trim());
        const rows = parsed.data;
        if(!rows.length){ show(qs('#masterEmpty')); return; }
        hide(qs('#masterEmpty'));
        const head = rows[0];
        const body = rows.slice(1).filter(r=>r.length && r.some(c=>String(c).trim()!==""));
        qs('#masterHead').innerHTML = `<tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr>`;
        qs('#masterBody').innerHTML = body.slice(0,300).map(r=>`<tr>${r.map(c=>`<td>${String(c||"")}</td>`).join('')}</tr>`).join('');
        // try to link to sheet editor
        const openLink = MASTER_CSV_URL.replace(/\/pub\?.*$/, "/edit");
        qs('#openMasterSheetLink').href = openLink;
      }catch(e){ console.error(e); }
    }

    /***********************
     * RENDER
     ***********************/
    function renderCounters(){
      qs('#totalLeadsCount').innerText = leads.length;
      qs('#individualReferralsCount').innerText = leads.filter(l => String(l["Referrer Type"]) === 'Individual').length;
      qs('#agencyReferralsCount').innerText = leads.filter(l => String(l["Referrer Type"]) === 'Agency').length;
      qs('#approvedCandidatesCount').innerText = leads.filter(l => String(l["Visa Status"]) === 'Approved').length;
    }

    function renderLeads(){
      const tbody = qs('#leadsTableBody');
      tbody.innerHTML = '';
      const search = qs('#searchInput').value.trim().toLowerCase();
      const typeF = qs('#referrerTypeFilter').value;
      const visaF = qs('#visaStatusFilter').value;
      const filtered = leads.filter(l => {
        const matchesSearch = !search || [
          l["Referrer Name"], l["Referrer Email"], l["Referrer Phone"],
          l["Client Name"], l["Client Email"], l["Client Phone"], l["Client Company/Position"]
        ].some(v => String(v||'').toLowerCase().includes(search));
        const matchesType = (typeF === 'all') || (String(l["Referrer Type"]||'') === typeF);
        const matchesVisa = (visaF === 'all') || (String(l["Visa Status"]||'') === visaF);
        return matchesSearch && matchesType && matchesVisa;
      });
      if(filtered.length === 0) show(qs('#noResults')); else hide(qs('#noResults'));

      filtered.forEach(l => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-800/40';
        tr.innerHTML = `
          <td>${l["Timestamp"] ? fmtTime(l["Timestamp"]) : ''}</td>
          <td>${l["Referrer Name"]||''}</td>
          <td>${l["Referrer Type"]||''}</td>
          <td>${l["Client Name"]||''}</td>
          <td>${l["Visa Type"]||''}</td>
          <td>${badgeForStatus(l["Visa Status"]||'In Progress')}</td>
          <td class="text-right pr-2">
            <button class="btn btn-ghost mr-2" onclick='viewLead(${JSON.stringify(l.rowNumber)})'>View</button>
            <button class="btn btn-ghost mr-2" onclick='editLead(${JSON.stringify(l.rowNumber)})'>Edit</button>
            <button class="btn btn-ghost" onclick='deleteLead(${JSON.stringify(l.rowNumber)})'>Del</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    /***********************
     * FORM HELPERS
     ***********************/
    function clearForm(){
      qsa('#leadForm input, #leadForm textarea, #leadForm select').forEach(el => {
        if(el.id === 'VisaType') { el.value = 'DTV'; return; }
        if(el.id === 'VisaStatus') { el.value = 'In Progress'; return; }
        if(el.id === 'ReferrerType') { el.value = 'Individual'; return; }
        if(el.id === 'PaymentStatus') { el.value = 'Pending'; return; }
        el.value = '';
      });
      hide(qs('#RejectionReasonDiv'));
      show(qs('#IndividualRewardDiv'));
      hide(qs('#AgencyPaymentDiv'));
      qs('#formError').innerText = '';
    }

    function collectFormData(){
      const rowNumber = qs('#rowNumber').value ? Number(qs('#rowNumber').value) : null;
      const refType = qs('#ReferrerType').value;
      const visaStatus = qs('#VisaStatus').value;
      const notesText = ""; // form doesn't edit notes; notes are handled in View modal

      const obj = {
        "Timestamp": new Date().toISOString(),
        "Referrer Name": qs('#ReferrerName').value.trim(),
        "Referrer Email": qs('#ReferrerEmail').value.trim(),
        "Referrer Phone": qs('#ReferrerPhone').value.trim(),
        "Referrer Type": refType,
        "Individual Reward": refType === 'Individual' ? qs('#IndividualReward').value : '',
        "Payment Status": refType === 'Agency' ? qs('#PaymentStatus').value : '',
        "Client Name": qs('#ClientName').value.trim(),
        "Client Email": qs('#ClientEmail').value.trim(),
        "Client Phone": qs('#ClientPhone').value.trim(),
        "Client Company/Position": qs('#ClientCompany').value.trim(),
        "Visa Type": qs('#VisaType').value,
        "Visa Status": visaStatus,
        "Rejection Reason": (visaStatus === 'Rejected') ? qs('#RejectionReason').value.trim() : '',
        "Notes": notesText
      };
      if(!obj["Referrer Name"]) throw new Error('Referrer Name is required.');
      if(!obj["Client Name"]) throw new Error('Client Name is required.');
      return rowNumber ? { rowNumber, ...obj } : obj;
    }

    /***********************
     * CRUD via Apps Script
     ***********************/
    async function reloadLeads(){
      try { await loadLeadsFromScript(); }
      catch(e){ console.warn('Falling back to CSV:', e.message); await loadLeadsFromCSV(); }
    }

    async function addOrUpdateLead(payload){
      const isEdit = !!payload.rowNumber;
      const url = `${SCRIPT_URL}?action=${isEdit ? 'update' : 'add'}`;
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error(`Server ${res.status}`);
      const out = await res.json();
      if(!out.ok) throw new Error(out.error || 'Unknown error');
    }

    async function deleteLead(rowNumber){
      if(!confirm('Delete this lead?')) return;
      const res = await fetch(`${SCRIPT_URL}?action=delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rowNumber }) });
      if(!res.ok) { alert('Delete failed.'); return; }
      const out = await res.json();
      if(!out.ok){ alert(out.error || 'Delete failed'); return; }
      await reloadLeads();
    }

    /***********************
     * NOTES (from View modal)
     * We store Notes as a JSON array string in the "Notes" cell.
     ***********************/
    function parseNotesCell(cell){
      if(!cell) return [];
      try { const val = JSON.parse(cell); return Array.isArray(val) ? val : []; }
      catch { return []; }
    }

    async function appendNote(rowNumber, noteText){
      const lead = leads.find(l => Number(l.rowNumber) === Number(rowNumber));
      const existing = parseNotesCell(lead && lead["Notes"]);
      const next = [...existing, { at: new Date().toISOString(), note: noteText }];
      const payload = { rowNumber, "Notes": JSON.stringify(next) };
      const res = await fetch(`${SCRIPT_URL}?action=update`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error(`Server ${res.status}`);
      const out = await res.json(); if(!out.ok) throw new Error(out.error || 'Update failed');
      await reloadLeads();
      viewLead(rowNumber); // reopen with updated notes
    }

    /***********************
     * UI ACTIONS
     ***********************/
    // Open add lead
    document.getElementById('addNewLeadBtn').onclick = () => { clearForm(); qs('#modalTitle').innerText = 'Add New Lead'; openModal('leadModal'); };

    // Conditional fields
    document.getElementById('ReferrerType').addEventListener('change', (e)=>{
      const isAgency = e.target.value === 'Agency';
      document.getElementById('IndividualRewardDiv').classList.toggle('hidden', isAgency);
      document.getElementById('AgencyPaymentDiv').classList.toggle('hidden', !isAgency);
    });
    document.getElementById('VisaStatus').addEventListener('change', (e)=>{
      const isRejected = e.target.value === 'Rejected';
      document.getElementById('RejectionReasonDiv').classList.toggle('hidden', !isRejected);
    });

    // Save lead
    document.getElementById('leadForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); qs('#formError').innerText = '';
      try { const payload = collectFormData(); await addOrUpdateLead(payload); closeModal('leadModal'); await reloadLeads(); }
      catch(err){ qs('#formError').innerText = err.message; }
    });

    // Filters
    qs('#searchInput').addEventListener('input', renderLeads);
    qs('#referrerTypeFilter').addEventListener('change', renderLeads);
    qs('#visaStatusFilter').addEventListener('change', renderLeads);
    qs('#refreshAll').addEventListener('click', async ()=>{ await Promise.all([reloadLeads(), loadMaster()]); });

    // View & Edit
    function viewLead(rowNumber){
      const l = leads.find(x => Number(x.rowNumber) === Number(rowNumber)); if(!l) return;
      const notesArr = parseNotesCell(l["Notes"]);
      const notesHtml = notesArr.length ? notesArr.map(n => `
        <div class="p-3 bg-slate-800 rounded-md border border-slate-700">
          <p class="text-sm">${n.note}</p>
          <p class="text-xs text-gray-400 mt-1">${new Date(n.at).toLocaleString()}</p>
        </div>`).join('') : '<p class="text-gray-400">No notes yet.</p>';

      const kv = (k, v) => `<div><p class="text-xs text-gray-400">${k}</p><p class="text-sm">${v||''}</p></div>`;

      qs('#profileContent').innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          ${kv('Referrer Name', l['Referrer Name'])}
          ${kv('Referrer Email', l['Referrer Email'])}
          ${kv('Referrer Phone', l['Referrer Phone'])}
          ${kv('Referrer Type', l['Referrer Type'])}
          ${kv('Client Name', l['Client Name'])}
          ${kv('Client Email', l['Client Email'])}
          ${kv('Client Phone', l['Client Phone'])}
          ${kv('Client Company/Position', l['Client Company/Position'])}
          ${kv('Visa Type', l['Visa Type'])}
          ${kv('Visa Status', l['Visa Status'])}
          ${l['Referrer Type']==='Individual' ? kv('Individual Reward', l['Individual Reward']) : ''}
          ${l['Referrer Type']==='Agency' ? kv('Payment Status', l['Payment Status']) : ''}
          ${l['Visa Status']==='Rejected' ? kv('Rejection Reason', l['Rejection Reason']) : ''}
        </div>
        <div class="space-y-3 mt-4">
          <h4 class="text-lg font-semibold text-white">Notes</h4>
          <div id="notesList" class="space-y-2">${notesHtml}</div>
          <textarea id="newNote" rows="2" class="input w-full" placeholder="Add a note (staff-only)"></textarea>
          <div class="flex justify-end"><button class="btn btn-primary" onclick='(function(){ const t=document.getElementById("newNote").value.trim(); if(!t) return; appendNote(${JSON.stringify(rowNumber)}, t); })()'>Add Note</button></div>
        </div>
        <div class="flex justify-end gap-2 pt-4">
          <button class="btn btn-ghost" onclick='editLead(${JSON.stringify(rowNumber)})'>Edit</button>
        </div>`;
      openModal('profileModal');
    }

    function editLead(rowNumber){
      const l = leads.find(x => Number(x.rowNumber) === Number(rowNumber)); if(!l) return;
      clearForm();
      qs('#modalTitle').innerText = 'Edit Lead';
      qs('#rowNumber').value = l.rowNumber || '';
      qs('#ReferrerName').value = l['Referrer Name'] || '';
      qs('#ReferrerEmail').value = l['Referrer Email'] || '';
      qs('#ReferrerPhone').value = l['Referrer Phone'] || '';
      qs('#ReferrerType').value = l['Referrer Type'] || 'Individual';
      qs('#ClientName').value = l['Client Name'] || '';
      qs('#ClientEmail').value = l['Client Email'] || '';
      qs('#ClientPhone').value = l['Client Phone'] || '';
      qs('#ClientCompany').value = l['Client Company/Position'] || '';
      qs('#VisaType').value = l['Visa Type'] || 'DTV';
      qs('#VisaStatus').value = l['Visa Status'] || 'In Progress';
      qs('#RejectionReason').value = l['Rejection Reason'] || '';
      const isAgency = (qs('#ReferrerType').value === 'Agency');
      document.getElementById('IndividualRewardDiv').classList.toggle('hidden', isAgency);
      document.getElementById('AgencyPaymentDiv').classList.toggle('hidden', !isAgency);
      if(isAgency) { qs('#PaymentStatus').value = l['Payment Status'] || 'Pending'; }
      else { qs('#IndividualReward').value = l['Individual Reward'] || 'Coworking'; }
      document.getElementById('RejectionReasonDiv').classList.toggle('hidden', qs('#VisaStatus').value !== 'Rejected');
      openModal('leadModal');
    }

    // expose for buttons in table
    window.viewLead = viewLead;
    window.editLead = editLead;
    window.deleteLead = deleteLead;

    /***********************
     * INIT
     ***********************/
    async function init(){
      try { await reloadLeads(); } catch(e){ console.error(e); try{ await loadLeadsFromCSV(); } catch(_){} }
      try { await loadMaster(); } catch(e){ console.error(e); }
    }

    window.onload = init;

    // cache-bust page once (useful on GitHub Pages)
    (function(){ const v=Date.now(); if(!location.href.includes('v=')){ const u=new URL(location.href); u.searchParams.set('v', v); history.replaceState({}, '', u.toString()); } })();
  </script>
</body>
</html>
