<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TDPK International Referral Program</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; background-color: #f3f4f6; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .status-badge { display:inline-block; padding:0.25rem 0.75rem; border-radius:9999px; font-size:0.75rem; font-weight:500; }
    .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
    .modal-content { background:#1f2937; margin:5% auto; padding:1.5rem; border-radius:0.75rem; width:90%; max-width:800px; }
    .close-button { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
    .close-button:hover { color:white; }
  </style>
</head>
<body class="bg-black text-gray-200 p-6 sm:p-10">

<div class="max-w-7xl mx-auto space-y-8">
  <!-- Header -->
  <header class="flex flex-col sm:flex-row items-center justify-between p-6 card bg-gray-800">
    <h1 class="text-3xl font-bold text-white">TDPK International Referral Program</h1>
    <span id="userIdDisplay" class="text-sm text-gray-400">Connected to Google Sheets</span>
  </header>

  <!-- Analytics Dashboard -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="p-6 card bg-gray-800 text-center"><p>Total Leads</p><p id="totalLeadsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Individual Referrals</p><p id="individualReferralsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Agency Referrals</p><p id="agencyReferralsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Approved Candidates</p><p id="approvedCandidatesCount" class="text-3xl">0</p></div>
  </div>

  <!-- CRM Table -->
  <div class="p-6 card bg-gray-800">
    <div class="flex justify-between mb-4">
      <h2 class="text-2xl">Referral Leads</h2>
      <button id="addNewLeadBtn" class="bg-blue-600 px-4 py-2 rounded">Add New Lead</button>
    </div>
    <table class="min-w-full divide-y divide-gray-700">
      <thead><tr><th>Time</th><th>Referrer</th><th>Type</th><th>Client</th><th>Visa</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="leadsTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="leadModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('leadModal')">&times;</span>
    <h3 id="modalTitle" class="text-xl mb-4">Add Lead</h3>
    <form id="leadForm" class="space-y-4">
      <input type="hidden" id="leadId" />
      <input id="referrerName" placeholder="Referrer Name" class="w-full p-2 bg-gray-700"/>
      <input id="referrerEmail" placeholder="Referrer Email" class="w-full p-2 bg-gray-700"/>
      <input id="referrerPhone" placeholder="Referrer Phone" class="w-full p-2 bg-gray-700"/>
      <select id="referrerType" class="w-full p-2 bg-gray-700"><option>Individual</option><option>Agency</option></select>
      <input id="clientName" placeholder="Client Name" class="w-full p-2 bg-gray-700"/>
      <input id="clientEmail" placeholder="Client Email" class="w-full p-2 bg-gray-700"/>
      <input id="clientPhone" placeholder="Client Phone" class="w-full p-2 bg-gray-700"/>
      <input id="clientCompany" placeholder="Client Company" class="w-full p-2 bg-gray-700"/>
      <select id="visaType" class="w-full p-2 bg-gray-700"><option>DTV</option><option>LTR</option><option>Smart S</option><option>TPC</option></select>
      <select id="visaStatus" class="w-full p-2 bg-gray-700"><option>In Progress</option><option>Approved</option><option>Rejected</option></select>
      <textarea id="rejectionReason" placeholder="Reason for Rejection" class="w-full p-2 bg-gray-700 hidden"></textarea>
      <div id="individualRewardDiv"><select id="individualReward" class="w-full p-2 bg-gray-700"><option>Coworking</option><option>Meeting Room</option></select></div>
      <div id="agencyPaymentDiv" class="hidden"><select id="paymentStatus" class="w-full p-2 bg-gray-700"><option>Pending</option><option>In Progress</option><option>Paid</option></select></div>
      <button class="w-full bg-blue-600 p-2 rounded" type="submit">Save</button>
    </form>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
    <h3 class="text-xl mb-4">Lead Profile</h3>
    <div id="profileContent"></div>
  </div>
</div>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=1540779843&single=true&output=csv";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzb4k9Jtp1uTTm9mcyiTxG6p_ZwMsvOlw8owyjvXmGSgn20m-fbyQbjT1lQt9UVFkc/exec";

let leads = [];

async function loadLeads(){
  const res = await fetch(SHEET_CSV_URL);
  const text = await res.text();
  const rows = text.split("\n").map(r => r.split(","));
  leads = rows.slice(1).map((r,i)=>({
    id:i+2, time:r[0], referrer:r[1], email:r[2], phone:r[3], type:r[4], client:r[5], clientEmail:r[6], clientPhone:r[7], company:r[8], visa:r[9], status:r[10], rejection:r[11], reward:r[12], payment:r[13], notes:r[14]?JSON.parse(r[14]):[]
  }));
  renderLeads();
}

function renderLeads(){
  const body = document.getElementById("leadsTableBody");
  body.innerHTML = "";
  leads.forEach(l=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${l.time}</td><td>${l.referrer}</td><td>${l.type}</td><td>${l.client}</td><td>${l.visa}</td><td>${l.status}</td>
    <td><button onclick="viewLead(${l.id})">View</button><button onclick="editLead(${l.id})">Edit</button><button onclick="deleteLead(${l.id})">Del</button></td>`;
    body.appendChild(tr);
  });
  document.getElementById("totalLeadsCount").innerText=leads.length;
  document.getElementById("individualReferralsCount").innerText=leads.filter(l=>l.type=="Individual").length;
  document.getElementById("agencyReferralsCount").innerText=leads.filter(l=>l.type=="Agency").length;
  document.getElementById("approvedCandidatesCount").innerText=leads.filter(l=>l.status=="Approved").length;
}

document.getElementById("addNewLeadBtn").onclick=()=>{
  document.getElementById("leadForm").reset();
  document.getElementById("modalTitle").innerText="Add Lead";
  openModal("leadModal");
};

document.getElementById("leadForm").onsubmit=async e=>{
  e.preventDefault();
  const data={referrerName:referrerName.value,referrerEmail:referrerEmail.value,referrerPhone:referrerPhone.value,referrerType:referrerType.value,clientName:clientName.value,clientEmail:clientEmail.value,clientPhone:clientPhone.value,clientCompany:clientCompany.value,visaType:visaType.value,visaStatus:visaStatus.value,rejectionReason:rejectionReason.value,individualReward:individualReward.value,paymentStatus:paymentStatus.value};
  await fetch(`${SCRIPT_URL}?action=add`,{method:"POST",body:JSON.stringify(data)});
  closeModal("leadModal"); loadLeads();
};

function editLead(id){
  const lead=leads.find(l=>l.id==id); if(!lead)return;
  document.getElementById("modalTitle").innerText="Edit Lead";
  referrerName.value=lead.referrer; referrerEmail.value=lead.email; referrerPhone.value=lead.phone;
  referrerType.value=lead.type; clientName.value=lead.client; clientEmail.value=lead.clientEmail;
  clientPhone.value=lead.clientPhone; clientCompany.value=lead.company; visaType.value=lead.visa; visaStatus.value=lead.status;
  rejectionReason.value=lead.rejection; individualReward.value=lead.reward; paymentStatus.value=lead.payment;
  openModal("leadModal");
}

async function deleteLead(row){
  if(!confirm("Delete this lead?"))return;
  await fetch(`${SCRIPT_URL}?action=delete`,{method:"POST",body:JSON.stringify({row})});
  loadLeads();
}

function viewLead(id){
  const lead=leads.find(l=>l.id==id); if(!lead)return;
  let profileHtml=`<p><b>Referrer:</b> ${lead.referrer} (${lead.email})</p>
  <p><b>Client:</b> ${lead.client} (${lead.clientEmail})</p>
  <p><b>Status:</b> ${lead.status}</p>`;
  if(lead.status=="Rejected"){ profileHtml+=`<p><b>Rejection Reason:</b> ${lead.rejection}</p>`; }
  if(lead.type=="Individual"){ profileHtml+=`<p><b>Reward:</b> ${lead.reward}</p>`; }
  if(lead.type=="Agency"){ profileHtml+=`<p><b>Payment Status:</b> ${lead.payment}</p>`; }
  profileHtml+=`<h4>Notes</h4>${lead.notes.map(n=>"<p>"+n.text+" ("+n.timestamp+")</p>").join("")}
  <textarea id="newNote"></textarea><button onclick="addNote(${id})">Add Note</button>`;
  document.getElementById("profileContent").innerHTML=profileHtml;
  openModal("profileModal");
}

async function addNote(id){
  const noteText=document.getElementById("newNote").value.trim(); if(!noteText)return;
  const lead=leads.find(l=>l.id==id); const updatedNotes=[...lead.notes,{text:noteText,timestamp:new Date().toISOString()}];
  await fetch(`${SCRIPT_URL}?action=update`,{method:"POST",body:JSON.stringify({row:id,notes:JSON.stringify(updatedNotes)})});
  loadLeads(); closeModal("profileModal");
}

function openModal(id){document.getElementById(id).style.display="block";}
function closeModal(id){document.getElementById(id).style.display="none";}
window.onload=loadLeads;
</script>

</body>
</html>
