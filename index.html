<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TDPK International Referral Program</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 1.5rem; border-radius: 0.75rem; width: 90%; max-width: 800px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
    textarea { resize: vertical; }
  </style>
</head>
<body class="bg-black text-gray-200 p-6 sm:p-10">

<div class="max-w-7xl mx-auto space-y-8">
  <!-- Header -->
  <header class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 p-6 card bg-gray-800">
    <div class="flex items-center space-x-4">
      <h1 class="text-xl sm:text-3xl font-bold text-white">TDPK International Referral Program</h1>
    </div>
    <div class="text-sm text-gray-400">
      <span class="font-semibold">Status:</span> <span id="userIdDisplay">Connected to Google Sheet</span>
    </div>
  </header>

  <!-- Main Dashboard -->
  <main class="space-y-8">
    <!-- Analytics Dashboard -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="p-6 card text-center bg-gray-800 text-gray-200">
        <p class="text-sm font-medium text-gray-400">Total Leads</p>
        <p id="totalLeadsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center bg-gray-800 text-gray-200">
        <p class="text-sm font-medium text-gray-400">Individual Referrals</p>
        <p id="individualReferralsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center bg-gray-800 text-gray-200">
        <p class="text-sm font-medium text-gray-400">Agency Referrals</p>
        <p id="agencyReferralsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center bg-gray-800 text-gray-200">
        <p class="text-sm font-medium text-gray-400">Approved Candidates</p>
        <p id="approvedCandidatesCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
    </div>

    <!-- CRM Table & Controls -->
    <div class="p-6 card bg-gray-800 text-gray-200">
      <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-4 sm:space-y-0">
        <h2 class="text-2xl font-semibold text-white">Referral Leads</h2>
        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
          <input type="text" id="searchInput" placeholder="Search by name or email..." class="p-2 border rounded-md w-full sm:w-64 bg-gray-700 text-white placeholder-gray-400 border-gray-600">
          <select id="referrerTypeFilter" class="p-2 border rounded-md w-full sm:w-auto bg-gray-700 text-white border-gray-600">
            <option value="all">Referrer Type: All</option>
            <option value="Individual">Individual</option>
            <option value="Agency">Agency</option>
          </select>
          <select id="visaStatusFilter" class="p-2 border rounded-md w-full sm:w-auto bg-gray-700 text-white border-gray-600">
            <option value="all">Visa Status: All</option>
            <option value="In Progress">In Progress</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
          <button id="addNewLeadBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-200 w-full sm:w-auto">Add New Lead</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700">
          <thead class="bg-gray-900">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Time</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Referrer Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Referral Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Client Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Visa Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Visa Status</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="leadsTableBody" class="bg-gray-800 divide-y divide-gray-700"></tbody>
        </table>
      </div>
      <div id="noResults" class="hidden text-center text-gray-400 mt-4 py-4">No matching leads found.</div>
    </div>
  </main>
</div>

<!-- Add/Edit Lead Modal -->
<div id="leadModal" class="modal">
  <div class="modal-content bg-gray-800 text-gray-200">
    <div class="flex justify-between items-center pb-3">
      <h3 id="modalTitle" class="text-2xl font-semibold text-white">Add New Lead</h3>
      <span class="close-button text-gray-400 hover:text-white">&times;</span>
    </div>
    <form id="leadForm" class="space-y-6">
      <input type="hidden" id="leadId">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label for="referrerName" class="block text-sm font-medium text-gray-300">Referrer Name</label><input type="text" id="referrerName" required class="mt-1 block w-full bg-gray-700 text-white"></div>
        <div><label for="referrerEmail" class="block text-sm font-medium text-gray-300">Referrer Email</label><input type="email" id="referrerEmail" required class="mt-1 block w-full bg-gray-700 text-white"></div>
        <div><label for="referrerPhone" class="block text-sm font-medium text-gray-300">Referrer Phone</label><input type="tel" id="referrerPhone" class="mt-1 block w-full bg-gray-700 text-white"></div>
        <div><label for="referrerType" class="block text-sm font-medium text-gray-300">Referrer Type</label><select id="referrerType" class="mt-1 block w-full bg-gray-700 text-white"><option value="Individual">Individual</option><option value="Agency">Agency</option></select></div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label for="clientName" class="block text-sm font-medium text-gray-300">Client Fullname</label><input type="text" id="clientName" required class="mt-1 block w-full bg-gray-700 text-white"></div>
        <div><label for="clientEmail" class="block text-sm font-medium text-gray-300">Client Email</label><input type="email" id="clientEmail" required class="mt-1 block w-full bg-gray-700 text-white"></div>
        <div><label for="clientPhone" class="block text-sm font-medium text-gray-300">Client Phone</label><input type="tel" id="clientPhone" class="mt-1 block w-full bg-gray-700 text-white"></div>
        <div><label for="clientCompany" class="block text-sm font-medium text-gray-300">Client Company</label><input type="text" id="clientCompany" class="mt-1 block w-full bg-gray-700 text-white"></div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label for="visaType" class="block text-sm font-medium text-gray-300">Visa Type</label><select id="visaType" class="mt-1 block w-full bg-gray-700 text-white"><option value="DTV">DTV</option><option value="LTR">LTR</option><option value="Smart S">Smart S</option><option value="TPC">TPC</option></select></div>
        <div><label for="visaStatus" class="block text-sm font-medium text-gray-300">Visa Status</label><select id="visaStatus" class="mt-1 block w-full bg-gray-700 text-white"><option value="In Progress">In Progress</option><option value="Approved">Approved</option><option value="Rejected">Rejected</option></select></div>
      </div>
      <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md">Save Lead</button>
    </form>
  </div>
</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzb4k9Jtp1uTTm9mcyiTxG6p_ZwMsvOlw8owyjvXmGSgn20m-fbyQbjT1lQt9UVFkc/exec"; // replace with Apps Script URL
  let leadsData = [];

  async function loadLeads() {
    const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=1540779843&single=true&output=csv");
    const csv = await response.text();
    const rows = csv.split("\n").map(r => r.split(","));
    leadsData = rows.slice(1).map((r, i) => ({ id: i+2, Timestamp: r[0], referrerName: r[1], referrerType: r[4], clientName: r[5], visaType: r[9], visaStatus: r[10] }));
    renderTable(leadsData);
  }

  function renderTable(leads) {
    const tbody = document.getElementById("leadsTableBody");
    tbody.innerHTML = "";
    leads.forEach(l => {
      const row = document.createElement("tr");
      row.innerHTML = `<td class="px-6 py-4">${l.Timestamp}</td><td class="px-6 py-4">${l.referrerName}</td><td class="px-6 py-4">${l.referrerType}</td><td class="px-6 py-4">${l.clientName}</td><td class="px-6 py-4">${l.visaType}</td><td class="px-6 py-4">${l.visaStatus}</td><td class="px-6 py-4 text-right"><button class="text-indigo-400 edit-btn" data-id="${l.id}">Edit</button></td>`;
      tbody.appendChild(row);
    });
    document.getElementById("totalLeadsCount").textContent = leads.length;
    document.getElementById("individualReferralsCount").textContent = leads.filter(l => l.referrerType==="Individual").length;
    document.getElementById("agencyReferralsCount").textContent = leads.filter(l => l.referrerType==="Agency").length;
    document.getElementById("approvedCandidatesCount").textContent = leads.filter(l => l.visaStatus==="Approved").length;
  }

  window.onload = loadLeads;
</script>
</body>
</html>
