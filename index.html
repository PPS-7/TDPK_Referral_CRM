<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TDPK International Referral Program — Referral CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; background-color: #0b0f17; }
    .card { background-color: #111826; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .modal { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.45); overflow: auto; }
    .modal-content { background: #111826; margin: 5% auto; padding: 1.25rem; border-radius: 0.75rem; width: 92%; max-width: 860px; }
    .close-button { color: #94a3b8; float: right; font-size: 28px; font-weight: 700; cursor: pointer; }
    .close-button:hover { color: #fff; }
    .input, select, textarea { background: #1f2937; color: #e5e7eb; border: 1px solid #374151; border-radius: .5rem; padding: .55rem .75rem; }
    th, td { padding: .75rem; }
    th { font-size: .75rem; text-transform: uppercase; color: #9ca3af; letter-spacing: .05em; }
    td { color: #e5e7eb; font-size: .95rem; }
    .btn { border-radius: .5rem; padding: .5rem .75rem; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #2563eb; color: #fff; border: none; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-ghost { background: #0f172a; border: 1px solid #334155; color: #e2e8f0; }
    .btn-ghost:hover { background: #111827; }
    .badge { display: inline-block; border-radius: 9999px; padding: .125rem .5rem; font-size: .75rem; }
    .badge.green { background: #064e3b; color: #a7f3d0; border: 1px solid #065f46; }
    .badge.yellow { background: #78350f; color: #fde68a; border: 1px solid #92400e; }
    .badge.red { background: #7f1d1d; color: #fecaca; border: 1px solid #991b1b; }
    .table-wrap { overflow: auto; border: 1px solid #1f2937; border-radius: .75rem; }
    .toggle .active { background: #2563eb; color: #fff; border-color: #2563eb; }
    .toggle .inactive { background: #0f172a; border: 1px solid #334155; color: #e2e8f0; }
    .loading { opacity: 0.6; pointer-events: none; }
    .error { color: #ef4444; }
    .success { color: #10b981; }
    .status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; }
  </style>
</head>
<body class="text-gray-200 p-6 sm:p-10">

  <div class="max-w-7xl mx-auto space-y-8">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 p-6 card">
      <div class="flex items-center space-x-4">
        <h1 class="text-xl sm:text-3xl font-bold text-white">TDPK International Referral Program — Referral CRM</h1>
      </div>
      <div class="text-sm text-gray-400 flex items-center">
        <span id="statusDot" class="status-dot bg-green-500"></span>
        <span class="font-semibold">Status:</span>&nbsp;<span id="userIdDisplay">Connected to Google Sheets</span>
      </div>
    </header>

    <!-- Analytics -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Total Leads</p>
        <p id="totalLeadsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Individual Referrals</p>
        <p id="individualReferralsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Agency Referrals</p>
        <p id="agencyReferralsCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
      <div class="p-6 card text-center">
        <p class="text-sm font-medium text-gray-400">Approved Candidates</p>
        <p id="approvedCandidatesCount" class="mt-1 text-3xl font-semibold text-white">0</p>
      </div>
    </section>

    <!-- Mode Toggle + Filters -->
    <section class="p-6 card space-y-4">
      <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
        <div class="toggle flex gap-2">
          <button id="btnIndividual" class="btn inactive">Individual Leads</button>
          <button id="btnAgency" class="btn inactive">Agency Leads</button>
        </div>
        <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto">
          <input type="text" id="searchInput" placeholder="Search by name, email, phone..." class="input w-full sm:w-64" />
          <select id="visaStatusFilter" class="input w-full sm:w-auto">
            <option value="all">Visa Status: All</option>
            <option value="In Progress">In Progress</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
          <button id="refreshAll" class="btn btn-ghost w-full sm:w-auto">Refresh</button>
        </div>
      </div>

      <!-- Tables -->
      <div class="table-wrap">
        <table class="min-w-full">
          <thead class="bg-gray-900 sticky top-0" id="tableHead"></thead>
          <tbody id="tableBody" class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
      <div id="noResults" class="hidden text-center text-gray-400 mt-4 py-4">No matching leads found.</div>
    </section>
  </div>

  <!-- Edit Lead Modal -->
  <div id="leadModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center pb-2">
        <h3 id="modalTitle" class="text-2xl font-semibold text-white">Edit Lead</h3>
        <span class="close-button" onclick="closeModal('leadModal')">&times;</span>
      </div>
      <form id="leadForm" class="space-y-6">
        <input type="hidden" id="rowNumber" />

        <!-- Always editable: Visa & core -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-300">Visa Status</label>
            <select id="VisaStatus" class="input w-full">
              <option>In Progress</option>
              <option>Approved</option>
              <option>Rejected</option>
            </select>
          </div>
          <div id="IndividualRewardDiv" class="hidden">
            <label class="block text-sm text-gray-300">Individual Reward</label>
            <select id="IndividualReward" class="input w-full">
              <option value="Coworking">1-month coworking space access</option>
              <option value="Meeting Room">3,000 THB of meeting room credit</option>
            </select>
          </div>
          <div id="IndividualRewardStatusDiv" class="hidden">
            <label class="block text-sm text-gray-300">Reward Status</label>
            <select id="RewardStatus" class="input w-full">
              <option>Pending</option>
              <option>Granted</option>
            </select>
          </div>
          <div id="AgencyPaymentDiv" class="hidden">
            <label class="block text-sm text-gray-300">Payment Status</label>
            <select id="PaymentStatus" class="input w-full">
              <option>Pending</option>
              <option>In Progress</option>
              <option>Initial Pay</option>
              <option>Fully Paid</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm text-gray-300">Notes</label>
          <textarea id="Notes" rows="3" class="input w-full" placeholder="Optional note (will be appended)"></textarea>
          <p class="text-xs text-gray-400 mt-1">Adding a note here will append to Notes history.</p>
        </div>

        <div class="flex items-center justify-end gap-2">
          <button type="button" class="btn btn-ghost" onclick="closeModal('leadModal')">Cancel</button>
          <button id="saveBtn" class="btn btn-primary" type="submit">Save Changes</button>
        </div>
        <p id="formError" class="text-sm"></p>
      </form>
    </div>
  </div>

  <!-- Profile (View) Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center pb-2">
        <h3 class="text-2xl font-semibold text-white">Lead Profile</h3>
        <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
      </div>
      <div id="profileContent" class="space-y-6"></div>
      <div class="flex justify-end pt-2">
        <button class="btn btn-ghost" onclick="closeModal('profileModal')">Close</button>
      </div>
    </div>
  </div>

<script>
/***********************
 * CONFIG
 ***********************/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwVj-YVmmAxMc1Jyp6i-OxlXvR9u13izg5C3QYqR_Xdf2mvRXy6I0SAMJMYbm_gPS5P/exec";
const MASTER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=1540779843&single=true&output=csv";

let leads = [];           // full dataset
let currentMode = "Individual"; // "Individual" | "Agency"
let isLoading = false;

/***********************
 * UTILS
 ***********************/
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const fmtTime = t => t ? new Date(t).toLocaleString() : "";
const badgeForStatus = s => {
  if (s === "Approved") return "<span class='badge green'>Approved</span>";
  if (s === "Rejected") return "<span class='badge red'>Rejected</span>";
  return "<span class='badge yellow'>In Progress</span>";
};

function openModal(id){qs("#"+id).style.display="block";}
function closeModal(id){qs("#"+id).style.display="none";}

function parseNotesCell(c){ 
  if(!c) return []; 
  try{ 
    const v = JSON.parse(c); 
    return Array.isArray(v)?v:[]; 
  }catch{ 
    return []; 
  } 
}

function setActiveModeButton(){
  const i=qs("#btnIndividual"), a=qs("#btnAgency");
  if(currentMode==="Individual"){
    i.classList.add("active"); i.classList.remove("inactive");
    a.classList.remove("active"); a.classList.add("inactive");
  }else{
    a.classList.add("active"); a.classList.remove("inactive");
    i.classList.remove("active"); i.classList.add("inactive");
  }
}

function showLoading(show = true) {
  isLoading = show;
  const body = document.body;
  const saveBtn = qs("#saveBtn");
  if (show) {
    body.classList.add('loading');
    if (saveBtn) saveBtn.disabled = true;
  } else {
    body.classList.remove('loading');
    if (saveBtn) saveBtn.disabled = false;
  }
}

function setStatus(connected, via = "Apps Script") {
  const label = qs("#userIdDisplay");
  const dot = qs("#statusDot");
  if (connected) {
    dot.classList.remove("bg-yellow-500", "bg-red-500");
    dot.classList.add("bg-green-500");
    label.textContent = `Connected (${via})`;
  } else {
    dot.classList.remove("bg-green-500", "bg-yellow-500");
    dot.classList.add("bg-red-500");
    label.textContent = "Disconnected";
  }
}

function showError(message) {
  const el = qs("#formError");
  if (!el) return;
  el.textContent = message;
  el.classList.remove("success");
  el.classList.add("error");
  setTimeout(() => {
    el.textContent = "";
    el.classList.remove("error");
  }, 5000);
}

function showSuccess(message) {
  const el = qs("#formError");
  if (!el) return;
  el.textContent = message;
  el.classList.remove("error");
  el.classList.add("success");
  setTimeout(() => {
    el.textContent = "";
    el.classList.remove("success");
  }, 2500);
}

/***********************
 * LOADERS
 ***********************/
async function reloadLeads(){
  try {
    showLoading(true);
    let out = null;

    // Try Apps Script API first
    try {
      const res = await fetch(SCRIPT_URL + "?action=load", { method: "GET" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      out = await res.json();
      leads = Array.isArray(out) ? out : (out && Array.isArray(out.data)) ? out.data : [];
      setStatus(true, "Apps Script");
    } catch (primaryErr) {
      console.warn("Primary load failed, falling back to CSV:", primaryErr);

      // Fallback to read-only CSV to at least render the UI
      const csvText = await fetch(MASTER_CSV_URL).then(r => {
        if (!r.ok) throw new Error(`CSV HTTP ${r.status}`);
        return r.text();
      });

      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      const normalized = parsed.data.map((row, idx) => {
        const obj = {};
        Object.keys(row).forEach(k => { obj[String(k).trim()] = row[k]; });
        obj.rowNumber = idx + 2; // header + 1-based
        return obj;
      });
      leads = normalized;
      setStatus(true, "CSV (read-only)");
    }

    renderCounters();
    renderTable();
  } catch (error) {
    console.error("Error loading leads:", error);
    setStatus(false);
    showError("Failed to load leads. Please try again.");
  } finally {
    showLoading(false);
  }
}

/***********************
 * COUNTERS
 ***********************/
function renderCounters(){
  qs("#totalLeadsCount").innerText = leads.length;
  qs("#individualReferralsCount").innerText = leads.filter(l => String(l["Referrer Type"])==="Individual").length;
  qs("#agencyReferralsCount").innerText = leads.filter(l => String(l["Referrer Type"])==="Agency").length;
  qs("#approvedCandidatesCount").innerText = leads.filter(l => String(l["Visa Status"])==="Approved").length;
}

/***********************
 * TABLE
 ***********************/
function renderTableHead(){
  const head = (currentMode==="Individual")
    ? ["Time","Referrer","Email","Client","Visa Type","Visa Status","Reward Status","Actions"]
    : ["Time","Referrer","Email","Client","Visa Type","Visa Status","Payment Status","Actions"];
  qs("#tableHead").innerHTML = `<tr>${head.map(h=>`<th class="text-center">${h}</th>`).join("")}</tr>`;
}

function renderTable(){
  renderTableHead();
  const tbody = qs("#tableBody");
  tbody.innerHTML = "";

  const visaF = qs("#visaStatusFilter").value;
  const search = qs("#searchInput").value.trim().toLowerCase();

  const filtered = leads.filter(l => {
    const isType = String(l["Referrer Type"]||"") === currentMode;
    if(!isType) return false;
    const matchesVisa = (visaF==="all") || (String(l["Visa Status"]||"")===visaF);
    const hay = [
      l["Referrer Name"], l["Referrer Email"], l["Referrer Phone"],
      l["Client Name"], l["Client Email"], l["Client Phone"], l["Client Company/Position"]
    ].map(v=>String(v||"").toLowerCase());
    const matchesSearch = !search || hay.some(v=>v.includes(search));
    return matchesVisa && matchesSearch;
  });

  if(filtered.length===0) qs("#noResults").classList.remove("hidden"); else qs("#noResults").classList.add("hidden");

  filtered.forEach(l => {
    const cells = (currentMode==="Individual")
      ? [
          (l["Timestamp"]?fmtTime(l["Timestamp"]):""),
          (l["Referrer Name"]||""),
          (l["Referrer Email"]||""),
          (l["Client Name"]||""),
          (l["Visa Type"]||""),
          (badgeForStatus(l["Visa Status"]||"In Progress")),
          (l["Reward Status"]||"Pending"),
        ]
      : [
          (l["Timestamp"]?fmtTime(l["Timestamp"]):""),
          (l["Referrer Name"]||""),
          (l["Referrer Email"]||""),
          (l["Client Name"]||""),
          (l["Visa Type"]||""),
          (badgeForStatus(l["Visa Status"]||"In Progress")),
          (l["Payment Status"]||"Pending"),
        ];

    const tr = document.createElement("tr");
    tr.className = "hover:bg-slate-800/40";
    tr.innerHTML = `
      ${cells.map(c=>`<td>${c}</td>`).join("")}
      <td class="text-right pr-2">
        <button class="btn btn-ghost mr-2" onclick='viewLead(${JSON.stringify(l.rowNumber)})'>View</button>
        <button class="btn btn-ghost" onclick='editLead(${JSON.stringify(l.rowNumber)})'>Edit</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/***********************
 * EDIT / VIEW
 ***********************/
function viewLead(rowNumber){
  const l = leads.find(x => Number(x.rowNumber)===Number(rowNumber));
  if(!l) return;

  const notesArr = parseNotesCell(l["Notes"]);
  const notesHtml = notesArr.length
    ? notesArr.map(n=>`
      <div class="p-3 bg-slate-800 rounded-md border border-slate-700">
        <p class="text-sm">${n.note}</p>
        <p class="text-xs text-gray-400 mt-1">${new Date(n.at).toLocaleString()}</p>
      </div>`).join("")
    : "<p class='text-gray-400'>No notes yet.</p>";

  const kv = (k,v) => `<div><p class="text-xs text-gray-400">${k}</p><p class="text-sm">${v||"—"}</p></div>`;

  const modeSpecific =
    (String(l["Referrer Type"])==="Individual")
      ? `${kv("Reward Selection", l["Individual Reward"])}${kv("Reward Status", l["Reward Status"])}`
      : `${kv("Payment Status", l["Payment Status"])}`;

  qs("#profileContent").innerHTML = `
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      ${kv("Referrer Name", l["Referrer Name"])}
      ${kv("Referrer Email", l["Referrer Email"])}
      ${kv("Referrer Phone", l["Referrer Phone"])}
      ${kv("Referrer Type", l["Referrer Type"])}
      ${kv("Client Name", l["Client Name"])}
      ${kv("Client Email", l["Client Email"])}
      ${kv("Client Phone", l["Client Phone"])}
      ${kv("Client Company/Position", l["Client Company/Position"])}
      ${kv("Visa Type", l["Visa Type"])}
      ${kv("Visa Status", l["Visa Status"])}
      ${modeSpecific}
      ${kv("Last Updated", l["Last Updated"] ? new Date(l["Last Updated"]).toLocaleString() : "—")}
    </div>
    <div class="space-y-3 mt-4">
      <h4 class="text-lg font-semibold text-white">Notes</h4>
      ${notesHtml}
      <div class="flex gap-2">
        <textarea id="newNote" rows="2" class="input w-full" placeholder="Add a note"></textarea>
        <button class="btn btn-primary" onclick='addNoteFromView(${JSON.stringify(rowNumber)})'>Add Note</button>
      </div>
    </div>
    <div class="flex justify-end gap-2 pt-4">
      <button class="btn btn-ghost" onclick='editLead(${JSON.stringify(rowNumber)})'>Edit</button>
    </div>`;
  openModal("profileModal");
}

function editLead(rowNumber){
  const l = leads.find(x => Number(x.rowNumber)===Number(rowNumber));
  if(!l) return;

  qs("#modalTitle").innerText = "Edit Lead";
  qs("#rowNumber").value = rowNumber;

  // Set editable fields
  qs("#VisaStatus").value = l["Visa Status"] || "In Progress";

  // Mode-specific fields
  const isIndividual = (String(l["Referrer Type"])==="Individual");
  qs("#IndividualRewardDiv").classList.toggle("hidden", !isIndividual);
  qs("#IndividualRewardStatusDiv").classList.toggle("hidden", !isIndividual);
  qs("#AgencyPaymentDiv").classList.toggle("hidden", isIndividual);

  if(isIndividual){
    qs("#IndividualReward").value = l["Individual Reward"] || "Coworking";
    qs("#RewardStatus").value = l["Reward Status"] || "Pending";
  }else{
    qs("#PaymentStatus").value = l["Payment Status"] || "Pending";
  }

  // Clear notes field for fresh append
  qs("#Notes").value = "";

  openModal("leadModal");
}

/***********************
 * UPDATE
 * Use text/plain to avoid browser CORS preflight OPTIONS
 ***********************/
async function addOrUpdateLead(payload){
  console.log("Sending payload to Apps Script:", payload);
  const url = `${SCRIPT_URL}?action=update`;
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    throw new Error(`HTTP error! status: ${res.status}`);
  }

  const out = await res.json();
  console.log("Response from Apps Script:", out);
  if(!out.ok) throw new Error(out.error || "Update failed");
  return out;
}

async function addNoteFromView(rowNumber) {
  const noteText = qs("#newNote").value.trim();
  if (!noteText) {
    showError("Please enter a note before adding.");
    return;
  }

  try {
    showLoading(true);
    await appendNote(rowNumber, noteText);
    qs("#newNote").value = ""; // Clear the input
    showSuccess("Note added successfully!");
  } catch (error) {
    console.error("Error adding note:", error);
    showError("Failed to add note. Please try again.");
  } finally {
    showLoading(false);
  }
}

async function appendNote(rowNumber, noteText){
  const l = leads.find(x => Number(x.rowNumber)===Number(rowNumber));
  if (!l) throw new Error("Lead not found");

  const existing = parseNotesCell(l["Notes"]);
  const next = [...existing, { at: new Date().toISOString(), note: noteText }];
  const payload = { rowNumber, "Notes": JSON.stringify(next) };
  await addOrUpdateLead(payload);
  await reloadLeads();
  viewLead(rowNumber);
}

/***********************
 * FORM HANDLER (EDIT ONLY)
 ***********************/
qs("#leadForm").addEventListener("submit", async (e)=>{
  e.preventDefault(); 
  qs("#formError").innerText = "";

  try{
    showLoading(true);
    const rowNumber = Number(qs("#rowNumber").value);
    const l = leads.find(x => Number(x.rowNumber)===rowNumber);
    if(!l) throw new Error("Lead not found.");

    const isIndividual = (String(l["Referrer Type"])==="Individual");
    const visaStatus = qs("#VisaStatus").value;

    const payload = {
      rowNumber,
      "Visa Status": visaStatus
    };

    if(isIndividual){
      payload["Individual Reward"] = qs("#IndividualReward").value;
      payload["Reward Status"] = qs("#RewardStatus").value;
    } else {
      payload["Payment Status"] = qs("#PaymentStatus").value;
    }

    const newNote = (qs("#Notes").value || "").trim();
    if(newNote){
      const existing = parseNotesCell(l["Notes"]);
      payload["Notes"] = JSON.stringify([...existing, { at: new Date().toISOString(), note: newNote }]);
    }

    await addOrUpdateLead(payload);
    closeModal("leadModal");
    await reloadLeads();
    showSuccess("Lead updated successfully!");
  }catch(err){
    console.error("Error updating lead:", err);
    showError(err.message || "Update failed.");
  } finally {
    showLoading(false);
  }
});

/***********************
 * MODE & FILTERS
 ***********************/
function setMode(mode){
  currentMode = mode; 
  setActiveModeButton(); 
  renderTable();
}

qs("#btnIndividual").addEventListener("click", ()=> setMode("Individual"));
qs("#btnAgency").addEventListener("click", ()=> setMode("Agency"));
qs("#visaStatusFilter").addEventListener("change", renderTable);
qs("#searchInput").addEventListener("input", renderTable);
qs("#refreshAll").addEventListener("click", reloadLeads);

/***********************
 * INIT
 ***********************/
async function init(){
  setMode("Individual");
  await reloadLeads();
}
window.onload = init;
</script>
</body>
</html>
