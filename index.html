<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TDPK International Referral Program</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; background-color: #f3f4f6; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .status-badge { display:inline-block; padding:0.25rem 0.75rem; border-radius:9999px; font-size:0.75rem; font-weight:500; }
    .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
    .modal-content { background:#1f2937; margin:5% auto; padding:1.5rem; border-radius:0.75rem; width:90%; max-width:800px; }
    .close-button { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
    .close-button:hover { color:white; }
  </style>
</head>
<body class="bg-black text-gray-200 p-6 sm:p-10">

<div class="max-w-7xl mx-auto space-y-8">
  <!-- Header -->
  <header class="flex flex-col sm:flex-row items-center justify-between p-6 card bg-gray-800">
    <h1 class="text-3xl font-bold text-white">TDPK International Referral Program</h1>
    <span id="userIdDisplay" class="text-sm text-gray-400">Connected to CRM Database</span>
  </header>

  <!-- Analytics Dashboard -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="p-6 card bg-gray-800 text-center"><p>Total Leads</p><p id="totalLeadsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Individual Referrals</p><p id="individualReferralsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Agency Referrals</p><p id="agencyReferralsCount" class="text-3xl">0</p></div>
    <div class="p-6 card bg-gray-800 text-center"><p>Approved Candidates</p><p id="approvedCandidatesCount" class="text-3xl">0</p></div>
  </div>

  <!-- CRM Table -->
  <div class="p-6 card bg-gray-800">
    <div class="flex flex-col sm:flex-row justify-between mb-4 space-y-4 sm:space-y-0">
      <h2 class="text-2xl">Referral Leads</h2>
      <div class="flex space-x-2">
        <input type="text" id="searchInput" placeholder="Search by name/email..." class="p-2 rounded bg-gray-700 text-white"/>
        <select id="referrerTypeFilter" class="p-2 rounded bg-gray-700 text-white">
          <option value="all">All Types</option>
          <option value="Individual">Individual</option>
          <option value="Agency">Agency</option>
        </select>
        <select id="visaStatusFilter" class="p-2 rounded bg-gray-700 text-white">
          <option value="all">All Status</option>
          <option value="In Progress">In Progress</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
        <button id="addNewLeadBtn" class="bg-blue-600 px-4 py-2 rounded">Add New Lead</button>
      </div>
    </div>
    <table class="min-w-full divide-y divide-gray-700">
      <thead><tr><th>Time</th><th>Referrer</th><th>Type</th><th>Client</th><th>Visa</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="leadsTableBody"></tbody>
    </table>
    <div id="noResults" class="hidden text-center text-gray-400 mt-4">No results</div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="leadModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('leadModal')">&times;</span>
    <h3 id="modalTitle" class="text-xl mb-4">Add Lead</h3>
    <form id="leadForm" class="space-y-4">
      <input type="hidden" id="leadRow" />
      <input id="referrerName" placeholder="Referrer Name" class="w-full p-2 bg-gray-700"/>
      <input id="referrerEmail" placeholder="Referrer Email" class="w-full p-2 bg-gray-700"/>
      <input id="referrerPhone" placeholder="Referrer Phone" class="w-full p-2 bg-gray-700"/>
      <select id="referrerType" class="w-full p-2 bg-gray-700"><option>Individual</option><option>Agency</option></select>
      <input id="clientName" placeholder="Client Name" class="w-full p-2 bg-gray-700"/>
      <input id="clientEmail" placeholder="Client Email" class="w-full p-2 bg-gray-700"/>
      <input id="clientPhone" placeholder="Client Phone" class="w-full p-2 bg-gray-700"/>
      <input id="clientCompany" placeholder="Client Company" class="w-full p-2 bg-gray-700"/>
      <select id="visaType" class="w-full p-2 bg-gray-700"><option>DTV</option><option>LTR</option><option>Smart S</option><option>TPC</option></select>
      <select id="visaStatus" class="w-full p-2 bg-gray-700"><option>In Progress</option><option>Approved</option><option>Rejected</option></select>
      <textarea id="rejectionReason" placeholder="Reason for Rejection" class="w-full p-2 bg-gray-700 hidden"></textarea>
      <div id="individualRewardDiv"><select id="individualReward" class="w-full p-2 bg-gray-700"><option>Coworking</option><option>Meeting Room</option></select></div>
      <div id="agencyPaymentDiv" class="hidden"><select id="paymentStatus" class="w-full p-2 bg-gray-700"><option>Pending</option><option>In Progress</option><option>Paid</option></select></div>
      <button class="w-full bg-blue-600 p-2 rounded" type="submit">Save</button>
    </form>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
    <h3 class="text-xl mb-4">Lead Profile</h3>
    <div id="profileContent"></div>
  </div>
</div>

<script>
const FORM_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=1540779843&single=true&output=csv";
const CRM_SHEET_API = "https://script.google.com/macros/s/AKfycbzb4k9Jtp1uTTm9mcyiTxG6p_ZwMsvOlw8owyjvXmGSgn20m-fbyQbjT1lQt9UVFkc/exec";

let leads = [];

async function loadCRMLeads(){
  const res = await fetch(`${CRM_SHEET_API}?action=getCRMLeads`,{method:"POST",body:JSON.stringify({})});
  const data = await res.json();
  leads = data;
  renderLeads();
}

function renderLeads(){
  const body = document.getElementById("leadsTableBody");
  body.innerHTML = "";
  const search = document.getElementById("searchInput").value.toLowerCase();
  const typeFilter = document.getElementById("referrerTypeFilter").value;
  const statusFilter = document.getElementById("visaStatusFilter").value;

  const filtered = leads.filter(l=>{
    const matchesSearch = !search || (l["Referrer Name"]||"").toLowerCase().includes(search) || (l["Client Name"]||"").toLowerCase().includes(search);
    const matchesType = typeFilter==="all" || l["Referrer Type"]===typeFilter;
    const matchesStatus = statusFilter==="all" || l["Visa Status"]===statusFilter;
    return matchesSearch && matchesType && matchesStatus;
  });

  filtered.forEach(l=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${l.Timestamp||""}</td><td>${l["Referrer Name"]||""}</td><td>${l["Referrer Type"]||""}</td><td>${l["Client Name"]||""}</td><td>${l["Visa Type"]||""}</td><td>${l["Visa Status"]||""}</td>
    <td><button onclick="viewLead(${l.row})">View</button> <button onclick="editLead(${l.row})">Edit</button> <button onclick="deleteLead(${l.row})">Del</button></td>`;
    body.appendChild(tr);
  });

  document.getElementById("totalLeadsCount").innerText=leads.length;
  document.getElementById("individualReferralsCount").innerText=leads.filter(l=>l["Referrer Type"]=="Individual").length;
  document.getElementById("agencyReferralsCount").innerText=leads.filter(l=>l["Referrer Type"]=="Agency").length;
  document.getElementById("approvedCandidatesCount").innerText=leads.filter(l=>l["Visa Status"]=="Approved").length;
}

document.getElementById("addNewLeadBtn").onclick=()=>{document.getElementById("leadForm").reset(); document.getElementById("leadRow").value=""; openModal("leadModal");};

document.getElementById("leadForm").onsubmit=async e=>{
  e.preventDefault();
  const data={
    "Referrer Name":referrerName.value,
    "Referrer Email":referrerEmail.value,
    "Referrer Phone":referrerPhone.value,
    "Referrer Type":referrerType.value,
    "Client Name":clientName.value,
    "Client Email":clientEmail.value,
    "Client Phone":clientPhone.value,
    "Client Company":clientCompany.value,
    "Visa Type":visaType.value,
    "Visa Status":visaStatus.value,
    "Rejection Reason":rejectionReason.value,
    "Individual Reward":individualReward.value,
    "Payment Status":paymentStatus.value,
  };
  if(leadRow.value){
    data.row=parseInt(leadRow.value);
    await fetch(`${CRM_SHEET_API}?action=updateCRMLead`,{method:"POST",body:JSON.stringify(data)});
  }else{
    await fetch(`${CRM_SHEET_API}?action=addCRMLead`,{method:"POST",body:JSON.stringify(data)});
  }
  closeModal("leadModal"); loadCRMLeads();
};

function editLead(row){
  const lead=leads.find(l=>l.row==row); if(!lead)return;
  leadRow.value=row;
  referrerName.value=lead["Referrer Name"]||""; referrerEmail.value=lead["Referrer Email"]||""; referrerPhone.value=lead["Referrer Phone"]||"";
  referrerType.value=lead["Referrer Type"]||"Individual"; clientName.value=lead["Client Name"]||""; clientEmail.value=lead["Client Email"]||"";
  clientPhone.value=lead["Client Phone"]||""; clientCompany.value=lead["Client Company"]||""; visaType.value=lead["Visa Type"]||"DTV"; visaStatus.value=lead["Visa Status"]||"In Progress";
  rejectionReason.value=lead["Rejection Reason"]||""; individualReward.value=lead["Individual Reward"]||"Coworking"; paymentStatus.value=lead["Payment Status"]||"Pending";
  openModal("leadModal");
}

async function deleteLead(row){
  if(!confirm("Delete this lead?"))return;
  await fetch(`${CRM_SHEET_API}?action=deleteCRMLead`,{method:"POST",body:JSON.stringify({row})});
  loadCRMLeads();
}

function viewLead(row){
  const lead=leads.find(l=>l.row==row); if(!lead)return;
  profileContent.innerHTML=`<p><b>Referrer:</b> ${lead["Referrer Name"]} (${lead["Referrer Email"]})</p>
  <p><b>Client:</b> ${lead["Client Name"]} (${lead["Client Email"]})</p>
  <p><b>Status:</b> ${lead["Visa Status"]}</p>`;
  openModal("profileModal");
}

function openModal(id){document.getElementById(id).style.display="block";}
function closeModal(id){document.getElementById(id).style.display="none";}

document.getElementById("searchInput").oninput=renderLeads;
document.getElementById("referrerTypeFilter").onchange=renderLeads;
document.getElementById("visaStatusFilter").onchange=renderLeads;

window.onload=loadCRMLeads;
</script>

</body>
</html>
